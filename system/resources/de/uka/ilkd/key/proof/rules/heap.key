\sorts {
    Field;
    Heap;
}


\functions {
    //select/store
    alpha alpha::select(Heap, Object, Field);
    Heap store(Heap, Object, Field, any);
    Heap anon(Heap, Set, Heap);
    Heap memset(Heap, Set, any);    
    
    //location sets    
    Set allLocs;
    Set allFields(Object);
    Set freshLocs(Heap);
    
    //fields
    \unique Field arr(int);
    \unique Field length;
    \unique Field java.lang.Object::<created>;
    \unique Field java.lang.Object::<initialized>;        
    \unique Field alpha::<classPrepared>;    			//static
    \unique Field alpha::<classInitialized>;			//static
    \unique Field alpha::<classInitializationInProgress>;	//static
    \unique Field alpha::<classErroneous>;			//static
    
    //null
    Null null;
}


\predicates {
    wellFormed(Heap);
}


\programVariables {
    Heap heap;
}


   

\rules {

    //--------------------------------------------------------------------------
    //axioms
    //--------------------------------------------------------------------------
    
    selectOfStore {
	\schemaVar \term Heap h;
	\schemaVar \term Object o, o2;
	\schemaVar \term Field f, f2;
	\schemaVar \term alpha x;
   
	\find(beta::select(store(h, o, f, x), o2, f2))
	
	\replacewith(\if(o = o2 & f = f2)
                     \then((beta)x)
                     \else(beta::select(h, o2, f2)))
                     
      	\heuristics(simplify)
    };
    
    
    selectOfAnon {
        \schemaVar \term Heap h, h2;
        \schemaVar \term Set s;
	\schemaVar \term Object o;
	\schemaVar \term Field f; 
	
        \find(beta::select(anon(h, s, h2), o, f))
        
        \replacewith(\if(elementOf(pair(o, f), s) & f != java.lang.Object::<created> 
                         | o != null & boolean::select(h, o, java.lang.Object::<created>)=FALSE)
                     \then(beta::select(h2, o, f))
                     \else(beta::select(h, o, f)))
                     
        \heuristics(simplify)
    };
    
    
    selectOfMemset {
        \schemaVar \term Heap h;
        \schemaVar \term Set s;
        \schemaVar \term any x;
	\schemaVar \term Object o;
	\schemaVar \term Field f; 
	
        \find(beta::select(memset(h, s, x), o, f))
        
        \replacewith(\if(elementOf(pair(o, f), s))
                     \then(x)
                     \else(beta::select(h, o, f)))
                     
        \heuristics(simplify)
    };
    
    
    elementOfAllLocs {
        \schemaVar \term Object o;
	\schemaVar \term Field f;        
        
        \find(elementOf(pair(o, f), allLocs))
        
        \replacewith(true)
        
        \heuristics(concrete)
    };
    
    
    elementOfAllLocsInt {
        \schemaVar \term int x;        
        
        \find(elementOf(x, allLocs))
        
        \replacewith(false)
        
        \heuristics(concrete)
    };
    
    
    elementOfAllLocsAny {
        \schemaVar \term any a;
        \schemaVar \variables Object ov;
        \schemaVar \variables Field fv;
        
        \find(elementOf(a, allLocs))
        \varcond(\notFreeIn(ov, a), \notFreeIn(fv, a))
        
        \replacewith(\exists ov; \exists fv; a = pair(ov, fv))
        
        \heuristics(simplify)
    };      
    
    
    elementOfAllFields {
        \schemaVar \term Object o, o2;
	\schemaVar \term Field f;        
        
        \find(elementOf(pair(o, f), allFields(o2)))
        
        \replacewith(o = o2)
        
        \heuristics(concrete)
    };
    
    
    elementOfAllFieldsAny {
        \schemaVar \term any a;
        \schemaVar \term Object o;
        \schemaVar \variables Field fv;
        
        \find(elementOf(a, allFields(o)))
        \varcond(\notFreeIn(fv, a), \notFreeIn(fv, o))
        
        \replacewith(\exists fv; a = pair(o, fv))
        
        \heuristics(simplify)
    };    
    
    
    elementOfFreshLocs {
        \schemaVar \term Object o;
	\schemaVar \term Field f;  
	\schemaVar \term Heap h;      
        
        \find(elementOf(pair(o, f), freshLocs(h)))
        
        \replacewith(!o=null & !boolean::select(h,o,java.lang.Object::<created>)=TRUE)
        
        \heuristics(concrete)
    };
    
    
    elementOfFreshLocsAny {
        \schemaVar \term any a;  
	\schemaVar \term Heap h;
	\schemaVar \variables Object ov;
	\schemaVar \variables Field fv;     
        
        \find(elementOf(a, freshLocs(h)))
        \varcond(\notFreeIn(ov, a), \notFreeIn(ov, h), \notFreeIn(fv, a), \notFreeIn(fv, h))
        
        \replacewith(\exists ov; \exists fv; (a = pair(ov, fv) & !ov=null & !boolean::select(h,ov,java.lang.Object::<created>)=TRUE))
        
        \heuristics(simplify)
    };

    
    selectToAnySelect { //partially hardcoded in DependencyContractPO
	\schemaVar \term Heap h;
	\schemaVar \term Object o;
	\schemaVar \term Field f;
   
	\find(beta::select(h, o, f))
	\varcond(\strict\sub(beta, any))
	
	\add(beta::select(h, o, f) = any::select(h, o, f) ==>)	
    };    
    
    
    //--------------------------------------------------------------------------
    //EQ versions of axioms (these are lemmata)
    //--------------------------------------------------------------------------
    
    selectOfStoreEQ {
	\schemaVar \term Heap h;
	\schemaVar \term Object o, o2;
	\schemaVar \term Field f, f2;
	\schemaVar \term alpha x;
	\schemaVar \term Heap EQ;
   
        \assumes(store(h, o, f, x) = EQ ==>)
	\find(beta::select(EQ, o2, f2))
        \sameUpdateLevel
	
	\replacewith(\if(o = o2 & f = f2)
                     \then((beta)x)
                     \else(beta::select(h, o2, f2)))
      	\heuristics(simplify)
    };
    
    
    selectOfAnonEQ {
        \schemaVar \term Heap h, h2;
        \schemaVar \term Set s;
	\schemaVar \term Object o;
	\schemaVar \term Field f;
	\schemaVar \term Heap EQ; 
	
	\assumes(anon(h, s, h2) = EQ ==>)
        \find(beta::select(EQ, o, f))
        \sameUpdateLevel
        
        \replacewith(\if(elementOf(pair(o, f), s) & f != java.lang.Object::<created> 
                         | o != null & boolean::select(h, o, java.lang.Object::<created>)=FALSE)
                     \then(beta::select(h2, o, f))
                     \else(beta::select(h, o, f)))
                     
        \heuristics(simplify)
    };    
    
    
    selectOfMemsetEQ {
        \schemaVar \term Heap h;
        \schemaVar \term Set s;
        \schemaVar \term any x;
	\schemaVar \term Object o;
	\schemaVar \term Field f;
	\schemaVar \term Heap EQ; 
	
	\assumes(memset(h, s, x) = EQ ==>)
        \find(beta::select(EQ, o, f))
        \sameUpdateLevel
        
        \replacewith(\if(elementOf(pair(o, f), s))
                     \then(x)
                     \else(beta::select(h, o, f)))
                     
        \heuristics(simplify)
    };        
       
       
    elementOfAllLocsEQ {
        \schemaVar \term Object o;
	\schemaVar \term Field f;
	\schemaVar \term Set EQ;        
        
        \assumes(allLocs = EQ ==>)
        \find(elementOf(pair(o, f), EQ))
        \sameUpdateLevel
                
        \replacewith(true)
        
        \heuristics(concrete)
    };
    
    
    elementOfAllFieldsEQ {
        \schemaVar \term Object o, o2;
	\schemaVar \term Field f;   
	\schemaVar \term Set EQ;     
        
        \assumes(allFields(o2) = EQ ==>)
        \find(elementOf(pair(o, f), EQ))
        \sameUpdateLevel
        
        \replacewith(o = o2)
        
        \heuristics(simplify)
    };
    
    
    elementOfFreshLocsEq {
        \schemaVar \term Object o, o2;
	\schemaVar \term Field f;
	\schemaVar \term Heap h;
	\schemaVar \term Set EQ;     	
        
        \assumes(freshLocs(h) = EQ ==>)
        \find(elementOf(pair(o, f), EQ))        
        
        \replacewith(!o=null & !boolean::select(h,o,java.lang.Object::<created>)=TRUE)
        
        \heuristics(simplify)
    };      
        
    
       
    //--------------------------------------------------------------------------
    //lemmata for some common cases
    //--------------------------------------------------------------------------
    
    dropEffectlessStores {
        \schemaVar \term Heap h, result;
        \schemaVar \term Object o;
        \schemaVar \term Field f;
	\schemaVar \term any x;	
	
	\find(store(h, o, f, x))
	\varcond(\dropEffectlessStores(h, o, f, x, result))
	
	\replacewith(result)
	
	\heuristics(concrete)
    };
        
    
    ifThenPairElse0Equality {
        \schemaVar \formula phi;
        \schemaVar \term Pair p, p2;
        
        \find(\if(phi)\then(p)\else(0) = p2)
        
        \replacewith(phi & p = p2)
        
        \heuristics(concrete)
    };
    
    
    ifThenPairElse0InAllLocs {
        \schemaVar \formula phi;
        \schemaVar \term Pair p, p2;
        
        \find(elementOf(\if(phi)\then(p)\else(0), allLocs))
        
        \replacewith(phi & elementOf(p, allLocs))
        
        \heuristics(concrete)
    };

    
    memsetEmpty {
        \schemaVar \term Heap h;
        \schemaVar \term any x;
        
        \find(memset(h, empty, x))
        
        \replacewith(h)
        
        \heuristics(concrete)
    };
}
